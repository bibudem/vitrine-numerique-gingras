var q=Object.defineProperty;var F=(f,g,e)=>g in f?q(f,g,{enumerable:!0,configurable:!0,writable:!0,value:e}):f[g]=e;var n=(f,g,e)=>F(f,typeof g!="symbol"?g+"":g,e);import{y as c,h as x,a as b,e as H,E as J}from"./app-UYNKwKlQ.js";import{W as X,d as o}from"./easing-0f4db1c0.esm-RA-xV_5T.js";import{cE as K,cH as M,b_ as Z,cF as $,bW as Y,cG as Q,cD as U,bX as v,bY as N,bV as V,cI as ee,cJ as te,q as C,av as se,au as ie}from"./vendor-BT8TDTHT.js";import{O as ae}from"./OrbitControls-Dgrw151P.js";import{R as ne}from"./RoomEnvironment-DveA1xVx.js";import"./@debug-lodash-BIjirobg.js";const oe=350,D=new K(1,1,1),h=new M({color:0,roughness:.5,metalness:.5}),l=new M({color:16777215,roughness:.5,metalness:.5});class ue extends X{constructor(e){var t,i;super(e);n(this,"handlers");n(this,"mouse",new Z);n(this,"raycaster");n(this,"container");n(this,"interactiveMesh",{});n(this,"lights",{});n(this,"clickTimers",{start:0,end:0});n(this,"isDown",!1);n(this,"ready",!1);n(this,"showButton",!1);n(this,"status",{toggle:!1});n(this,"orbitControls");n(this,"pmremGenerator");return c.toneMapping=$,this.handlers={clickDown:this.onClickDown.bind(this),click:this.onClick.bind(this),move:this.onMouseMove.bind(this)},((t=this.settings)==null?void 0:t.tranche).charAt(0)==="#"&&h.color.setStyle((i=this.settings)==null?void 0:i.tranche),this.container=new Y,this.container.position.z=-.5,this.container.visible=!1,this.orbitControls=new ae(this.getActiveCamera(),c.domElement),this.orbitControls.enableDamping=!0,this.orbitControls.enablePan=!1,this.orbitControls.dampingFactor=.1,this.orbitControls.enableZoom=!1,this.pmremGenerator=new Q(c),this.pmremGenerator.compileEquirectangularShader(),this.scene.environment=this.pmremGenerator.fromScene(new ne).texture,this.scene.environmentIntensity=.25,this.raycaster=new U,this}async build(){var L,T,I,R,S,G,A,P,B,O,_,W,j;this.scene.add(this.container);const e=new Y;this.interactiveMesh.front=e,this.container.add(this.interactiveMesh.front);const t=await((I=x.getLoader("texture"))==null?void 0:I.loadAsync(((L=this.settings)==null?void 0:L.folder)+((T=this.settings)==null?void 0:T.recto)));t&&this.prepareTexture(t);const i=(t==null?void 0:t.image.width)/(t==null?void 0:t.image.height),s=new v(D,[h,h,h,h,new M({map:t,roughness:.5,metalness:.5}),h]);s.name="frontCover",s.scale.set(2,2/i,.02),s.position.x=s.scale.x/2,e.add(s),e.position.x=-s.position.x;const a=new v(D,new M({color:(R=this.settings)==null?void 0:R.tranche,roughness:.5,metalness:.5}));a.scale.set(.1,s.scale.y,.02),a.rotation.y=Math.PI/2,a.position.set(-s.scale.x/2,0,-a.scale.x/2),this.interactiveMesh.tranche=a,this.container.add(this.interactiveMesh.tranche);const d=await((A=x.getLoader("texture"))==null?void 0:A.loadAsync(((S=this.settings)==null?void 0:S.folder)+((G=this.settings)==null?void 0:G.verso)));d&&this.prepareTexture(d);const u=new v(D,[h,h,h,h,h,new M({map:d,roughness:.5,metalness:.5})]);u.scale.copy(s.scale),u.position.set(0,0,-a.scale.x),this.interactiveMesh.back=u,this.container.add(this.interactiveMesh.back);const E=await((O=x.getLoader("texture"))==null?void 0:O.loadAsync(((P=this.settings)==null?void 0:P.folder)+((B=this.settings)==null?void 0:B.page_1)));E&&this.prepareTexture(E);const w=new v(D,[l,l,l,l,new M({map:E,roughness:.5,metalness:.5}),l]);w.scale.set(s.scale.x,s.scale.y*.98,.05),w.position.z=-a.scale.x/2-.02,w.position.x=0,this.interactiveMesh.pageRight=w,this.container.add(this.interactiveMesh.pageRight);const z=await((j=x.getLoader("texture"))==null?void 0:j.loadAsync(((_=this.settings)==null?void 0:_.folder)+((W=this.settings)==null?void 0:W.page_2)));z&&this.prepareTexture(z);const k=new v(D,[l,l,l,l,l,new M({map:z,roughness:.5,metalness:.5})]);k.scale.copy(w.scale),k.position.z=a.scale.x/2-.08,k.position.x=k.scale.x/2,this.interactiveMesh.pageLeft=k,e.add(this.interactiveMesh.pageLeft);const y=x.getTexture("sprite-object");if(y){this.prepareTexture(y,!1);const m=y.image.width/y.image.height,r=new v(new N(1,1),new V({map:y,transparent:!0}));r.name="click",r.scale.set(1,1/m,1).multiplyScalar(.5),r.position.x=s.scale.x/2,r.position.z=.03,r.userData.scale=r.scale.clone(),r.scale.set(0,0,0),this.interactiveMesh.click=r,this.container.add(r)}if(b.state.supports.install&&!b.hasInteract.book){const m=x.getTexture("touch-object");if(m){this.prepareTexture(m,!1);const r=m.image.width/m.image.height,p=new v(new N(1,1),new V({map:m,transparent:!0}));p.name="picto",p.scale.set(1,1/r,1).multiplyScalar(.5),p.position.x=s.scale.x/2,p.position.z=.03,p.userData.scale=p.scale.clone(),p.scale.set(0,0,0),this.interactiveMesh.picto=p,this.container.add(p)}}this.lights={ambient:new ee(16777215,3),directional:new te(16777215,1)},this.container.add(this.lights.ambient),this.lights.directional.position.set(-3,2,7.5),this.container.add(this.lights.directional),H.emit(J.OBJECT_DETAIL_READY),this.ready=!0,this.addEvents(),C.timeline().from(this.container.rotation,{z:Math.PI/4,x:-Math.PI/2,ease:"power4.inOut",duration:2})}addEvents(){var e,t,i;(e=c)==null||e.domElement.addEventListener("pointerdown",this.handlers.clickDown),(t=c)==null||t.domElement.addEventListener("pointerup",this.handlers.click),(i=c)==null||i.domElement.addEventListener("pointermove",this.handlers.move)}removeEvents(){var e,t,i;(e=c)==null||e.domElement.removeEventListener("pointerdown",this.handlers.clickDown),(t=c)==null||t.domElement.removeEventListener("pointerup",this.handlers.click),(i=c)==null||i.domElement.removeEventListener("pointermove",this.handlers.move)}resize(){super.resize()}render(e){var t;if(!this.scene.children.length)super.render(e),this.build();else if(super.render(e),this.ready){const i=(t=this.interactiveMesh.front)==null?void 0:t.getObjectByName("frontCover"),s=this.interactiveMesh.tranche;o(this.interactiveMesh.front.rotation,"y",this.status.toggle?-Math.PI:0,.2,e.delta),o(this.interactiveMesh.front.position,"x",this.status.toggle?-i.scale.x/2-s.scale.x:-i.scale.x/2,.2,e.delta),o(this.interactiveMesh.front.position,"z",this.status.toggle?-s.scale.x:0,.2,e.delta),o(this.interactiveMesh.tranche.rotation,"y",this.status.toggle?0:Math.PI/2,.2,e.delta),o(this.interactiveMesh.tranche.position,"x",this.status.toggle?-i.scale.x/2-s.scale.x/2:-i.scale.x/2,.2,e.delta),o(this.interactiveMesh.tranche.position,"z",this.status.toggle?-s.scale.x:-(s.scale.x/2),.2,e.delta),o(this.interactiveMesh.pageRight.position,"x",this.status.toggle?-s.scale.x/2+.02:0,.2,e.delta),o(this.interactiveMesh.pageLeft.position,"x",this.status.toggle?this.interactiveMesh.pageLeft.scale.x/2-s.scale.x/2:this.interactiveMesh.pageLeft.scale.x/2,.2,e.delta),o(this.interactiveMesh.pageRight.scale,"z",this.status.toggle?.02:.05,.2,e.delta),o(this.interactiveMesh.pageLeft.scale,"z",this.status.toggle?.02:.05,.2,e.delta),o(this.container.position,"x",this.status.toggle?this.container.scale.x:0,.2,e.delta),o(this.container.position,"z",this.status.toggle?1:-.5,.2,e.delta)}this.orbitControls.update()}dispose(){this.disposeGeometries(this.container),this.interactiveMesh={},super.dispose(),this.removeEvents(),document.body.style.cursor="default"}onClickDown(){this.clickTimers.start=Date.now(),this.clickTimers.end=0,this.isDown=!0}onClick(e){this.clickTimers.end=Date.now(),this.isDown=!1,this.clickTimers.end-this.clickTimers.start<=oe&&this.interactiveMesh.front&&(this.getMousePosition(e),this.checkIntersection(e,"click"))}onMouseMove(e){if(b.state.supports.install){this.userInteract();return}this.getMousePosition(e),this.interactiveMesh.front&&this.checkIntersection(e,"move")}getMousePosition(e){const i=e.currentTarget.getBoundingClientRect();let s=0,a=0;s=e.clientX-(i==null?void 0:i.left),a=e.clientY-(i==null?void 0:i.top),this.mouse.x=s/c.domElement.offsetWidth*2-1,this.mouse.y=-(a/c.domElement.offsetHeight)*2+1}show(){this.container.visible=!0}toggleShowingInside(e){var t,i,s,a,d,u;e&&(this.interactiveMesh.picto?C.timeline().set(this.interactiveMesh.picto.scale,{x:0,y:0,z:0},0).to(this.interactiveMesh.picto.scale,{x:(a=this.interactiveMesh.picto)==null?void 0:a.userData.scale.x,y:(d=this.interactiveMesh.picto)==null?void 0:d.userData.scale.y,z:(u=this.interactiveMesh.picto)==null?void 0:u.userData.scale.z,ease:"power4.out",overwrite:!1,duration:.5},.5):C.timeline().set(this.interactiveMesh.click.scale,{x:0,y:0,z:0},0).to(this.interactiveMesh.click.scale,{x:(t=this.interactiveMesh.click)==null?void 0:t.userData.scale.x,y:(i=this.interactiveMesh.click)==null?void 0:i.userData.scale.y,z:(s=this.interactiveMesh.click)==null?void 0:s.userData.scale.z,ease:"power4.out",overwrite:!1,duration:.5},.5))}prepareTexture(e,t=!0){e.colorSpace=se,t&&(e.generateMipmaps=!1,e.minFilter=ie)}checkIntersection(e,t="click"){var s,a,d;this.raycaster.setFromCamera(this.mouse,this.getActiveCamera());const i=this.raycaster.intersectObject(this.interactiveMesh.click);if(t==="move"){const u=i.length>0;document.body.style.cursor=u?"pointer":"default"}i.length&&t==="click"&&(this.status.toggle=!this.status.toggle,C.timeline().to(this.interactiveMesh.click.scale,{x:0,y:0,z:0,ease:"power4.out",duration:.5},0).to(this.interactiveMesh.click.scale,{x:this.status.toggle?.35:(s=this.interactiveMesh.click)==null?void 0:s.userData.scale.x,y:this.status.toggle?.35:(a=this.interactiveMesh.click)==null?void 0:a.userData.scale.y,z:this.status.toggle?.35:(d=this.interactiveMesh.click)==null?void 0:d.userData.scale.z,ease:"power4.out",overwrite:!1,duration:.5},1))}revertToInteractive(){}userInteract(){var e,t,i;b.hasInteract.book||(b.toggleInteraction(!0,"book"),this.interactiveMesh.picto&&C.timeline().to(this.interactiveMesh.picto.scale,{x:0,y:0,z:0,ease:"power4.out",duration:.5,onComplete:()=>{var s,a;(a=((s=this.interactiveMesh.picto)==null?void 0:s.material).map)==null||a.dispose(),this.container.remove(this.interactiveMesh.picto),this.interactiveMesh.picto=void 0}},0).set(this.interactiveMesh.click.scale,{x:0,y:0,z:0},0).to(this.interactiveMesh.click.scale,{x:(e=this.interactiveMesh.click)==null?void 0:e.userData.scale.x,y:(t=this.interactiveMesh.click)==null?void 0:t.userData.scale.y,z:(i=this.interactiveMesh.click)==null?void 0:i.userData.scale.z,ease:"power4.out",overwrite:!1,duration:.5},.7))}}export{ue as BookScene};
//# sourceMappingURL=BookScene-BRYwrODj.js.map

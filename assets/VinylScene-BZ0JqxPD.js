var K=Object.defineProperty;var Z=(v,p,t)=>p in v?K(v,p,{enumerable:!0,configurable:!0,writable:!0,value:t}):v[p]=t;var o=(v,p,t)=>Z(v,typeof p!="symbol"?p+"":p,t);import{W as $,d as f}from"./easing-0f4db1c0.esm-RA-xV_5T.js";import{cE as Q,bY as E,b_ as tt,cF as et,bW as S,cG as it,cD as st,bV as b,ac as B,bX as k,cH as T,cI as at,cJ as nt,q as m,av as rt,au as ot}from"./vendor-BT8TDTHT.js";import{y as u,h as w,a as g,e as F,E as U,x as ct,O as ht}from"./app-UYNKwKlQ.js";import{O as lt}from"./OrbitControls-Dgrw151P.js";import{R as ut}from"./RoomEnvironment-DveA1xVx.js";import"./@debug-lodash-BIjirobg.js";const D=new Q(1,1,1),C=new E(1,1),dt=350;class xt extends ${constructor(t){super(t);o(this,"handlers");o(this,"mouse",new tt);o(this,"moveArticle",!1);o(this,"raycaster");o(this,"clickTimers",{start:0,end:0});o(this,"isDown",!1);o(this,"container");o(this,"interactiveMesh",{});o(this,"lights",{});o(this,"status",{toggle:!1,reduce:!1});o(this,"orbitControls");o(this,"orbitDefaultState",{});o(this,"pmremGenerator");return u.toneMapping=et,this.handlers={clickDown:this.onClickDown.bind(this),click:this.onClick.bind(this),move:this.onMouseMove.bind(this)},this.container=new S,this.container.position.x=-this.container.scale.x/2,this.container.visible=!1,this.orbitControls=new lt(this.getActiveCamera(),u.domElement),this.orbitControls.enableDamping=!0,this.orbitControls.enablePan=!1,this.orbitControls.dampingFactor=.1,this.orbitControls.enableZoom=!1,this.pmremGenerator=new it(u),this.pmremGenerator.compileEquirectangularShader(),this.scene.environment=this.pmremGenerator.fromScene(new ut).texture,this.scene.environmentIntensity=.25,this.raycaster=new st,this}async build(){var d,x,z,A,L,O,_,G,P,R,j,W,N,V,X,Y,H,J,q;this.scene.add(this.container);const t=w.getModel("vinyl").clone();t.name="vinyl",t.scale.multiplyScalar(.09),this.container.add(t),t.traverse(r=>{const M=r;M.name==="Disc"&&(this.interactiveMesh.disc=M,this.interactiveMesh.disc.position.x=0)}),this.interactiveMesh.cover=new S,this.container.add(this.interactiveMesh.cover);const e=await((z=w.getLoader("texture"))==null?void 0:z.loadAsync(((d=this.settings)==null?void 0:d.folder)+((x=this.settings)==null?void 0:x.recto)));e&&this.prepareTexture(e);const i=await((O=w.getLoader("texture"))==null?void 0:O.loadAsync(((A=this.settings)==null?void 0:A.folder)+((L=this.settings)==null?void 0:L.verso)));i&&this.prepareTexture(i),this.interactiveMesh.trancheInsideMaterial=new b({color:(_=this.settings)==null?void 0:_.tranche,transparent:!0,opacity:1});const n=new b({color:(G=this.settings)==null?void 0:G.tranche,side:B}),a=new k(D,[this.interactiveMesh.trancheInsideMaterial,n,n,n,new T({map:e,side:B,roughness:.5,metalness:.5}),new T({map:i,side:B})]),c=(e==null?void 0:e.image.width)/(e==null?void 0:e.image.height);if(a.name="cover",a.scale.set(2.5,2.5/c,.05),this.interactiveMesh.cover.add(a),(P=this.settings)!=null&&P.article){const r=new S;this.container.add(r),this.interactiveMesh.article=r;const M=typeof((R=this.settings)==null?void 0:R.article)!="string",h=((j=this.settings)==null?void 0:j.folder)+(M?(W=this.settings)==null?void 0:W.article[0]:(N=this.settings)==null?void 0:N.article),y=await((V=w.getLoader("texture"))==null?void 0:V.loadAsync(h));if(y){this.prepareTexture(y);const l=new k(C,new T({map:y,roughness:.5,metalness:.5})),I=y.image.width/y.image.height;l.name="article",l.scale.set((X=this.settings)==null?void 0:X.article_scale,((Y=this.settings)==null?void 0:Y.article_scale)/I,(H=this.settings)==null?void 0:H.article_scale),r.position.z=.01,r.position.y=.2,r.add(l),(J=this.settings)!=null&&J.article_offset&&(r.position.x+=(q=this.settings)==null?void 0:q.article_offset);const s=new k(new E(1,1),new b({transparent:!0,opacity:0}));s.name="click",s.scale.set(1,l.scale.y,1),s.userData.x=s.position.x,s.userData.endX=s.userData.x+(l.scale.x/2-s.scale.x/2),this.interactiveMesh.click=s,r.add(s)}if(!g.state.supports.install&&!g.hasInteract.vinyl){const l=w.getTexture("sprite-object");if(l){this.prepareTexture(l,!1);const I=l.image.width/l.image.height,s=new k(new E(1,1),new b({map:l,transparent:!0}));s.name="clickButtton",s.scale.set(1,1/I,1).multiplyScalar(.5),s.position.x=a.scale.x/2+r.scale.x/2-.2,s.position.z=.07,s.userData.scale=s.scale.clone(),s.scale.set(0,0,0),this.interactiveMesh.clickButtton=s,this.container.add(s)}}}if(g.state.supports.install&&!g.hasInteract.vinyl){const r=w.getTexture("touch-object");if(r){this.prepareTexture(r,!1);const M=r.image.width/r.image.height,h=new k(new E(1,1),new b({map:r,transparent:!0}));h.name="picto",h.scale.set(1,1/M,1).multiplyScalar(.5),h.position.x=a.scale.x/2+this.interactiveMesh.disc.scale.x+.15,h.position.z=.03,h.userData.scale=h.scale.clone(),h.scale.set(0,0,0),this.interactiveMesh.picto=h,this.container.add(h)}}this.lights={ambient:new at(16777215,3),directional:new nt(16777215,1)},this.container.add(this.lights.ambient),this.lights.directional.position.set(-3,2,7.5),this.container.add(this.lights.directional),F.emit(U.OBJECT_DETAIL_READY),this.orbitDefaultState.target=this.orbitControls.target.clone(),this.orbitDefaultState.cam=this.getActiveCamera().position.clone(),this.addEvents(),m.timeline().from(this.container.rotation,{z:Math.PI/4,x:-Math.PI/2,ease:"power4.inOut",duration:2})}addEvents(){var t,e,i;(t=u)==null||t.domElement.addEventListener("pointerdown",this.handlers.clickDown),(e=u)==null||e.domElement.addEventListener("pointerup",this.handlers.click),(i=u)==null||i.domElement.addEventListener("pointermove",this.handlers.move)}removeEvents(){var t,e,i;(t=u)==null||t.domElement.removeEventListener("pointerdown",this.handlers.clickDown),(e=u)==null||e.domElement.removeEventListener("pointerup",this.handlers.click),(i=u)==null||i.domElement.removeEventListener("pointermove",this.handlers.move)}resize(){super.resize()}render(t){var e,i;this.scene.children.length?(super.render(t),this.interactiveMesh.disc&&this.interactiveMesh.cover&&(f(this.interactiveMesh.disc.position,"x",this.status.toggle?this.interactiveMesh.disc.scale.x*15:0,.2,t.delta),f(this.interactiveMesh.disc.rotation,"z",this.status.toggle?Math.PI/2:0,.2,t.delta),this.interactiveMesh.trancheInsideMaterial&&f(this.interactiveMesh.trancheInsideMaterial,"opacity",this.status.toggle?0:1,.2,t.delta),this.interactiveMesh.article&&this.moveArticle&&(f(this.interactiveMesh.article.position,"x",this.status.toggle?(((e=this.settings)==null?void 0:e.article_offset)??0)+.65:((i=this.settings)==null?void 0:i.article_offset)??0,.25,t.delta),f(this.interactiveMesh.article.rotation,"z",this.status.toggle?-Math.PI/8:0,.25,t.delta),f(this.interactiveMesh.click.position,"x",this.status.toggle?this.interactiveMesh.click.userData.endX:this.interactiveMesh.click.userData.x,.25,t.delta)))):(super.render(t),this.build()),this.orbitControls.update()}dispose(){var t;C==null||C.dispose(),D==null||D.dispose(),(t=this.interactiveMesh.trancheInsideMaterial)==null||t.dispose(),this.disposeGeometries(this.container),this.interactiveMesh={},super.dispose(),this.removeEvents(),document.body.style.cursor="default"}onClickDown(){this.clickTimers.start=Date.now(),this.clickTimers.end=0,this.isDown=!0}onClick(t){var i;this.clickTimers.end=Date.now(),this.isDown=!1,this.clickTimers.end-this.clickTimers.start<=dt&&(i=this.settings)!=null&&i.article&&this.interactiveMesh.article&&(this.getMousePosition(t),this.checkIntersection(t,"click"))}onMouseMove(t){var e;if(g.state.supports.install){this.userInteract();return}this.getMousePosition(t),(e=this.settings)!=null&&e.article&&this.interactiveMesh.article&&this.checkIntersection(t,"move")}getMousePosition(t){const i=t.currentTarget.getBoundingClientRect();let n=0,a=0;n=t.clientX-(i==null?void 0:i.left),a=t.clientY-(i==null?void 0:i.top),this.mouse.x=n/u.domElement.offsetWidth*2-1,this.mouse.y=-(a/u.domElement.offsetHeight)*2+1}show(){this.container.visible=!0}toggleShowingInside(t){this.status.toggle=t,setTimeout(()=>{var e,i,n,a,c,d;this.moveArticle=t,this.status.toggle&&this.interactiveMesh.clickButtton&&(this.interactiveMesh.clickButtton.parent||this.container.add(this.interactiveMesh.clickButtton),m.timeline().set(this.interactiveMesh.clickButtton.scale,{x:0,y:0,z:0},0).to(this.interactiveMesh.clickButtton.scale,{x:(e=this.interactiveMesh.clickButtton)==null?void 0:e.userData.scale.x,y:(i=this.interactiveMesh.clickButtton)==null?void 0:i.userData.scale.y,z:(n=this.interactiveMesh.clickButtton)==null?void 0:n.userData.scale.z,ease:"power4.out",overwrite:!1,duration:.5},.5)),this.interactiveMesh.picto&&m.timeline().set(this.interactiveMesh.picto.scale,{x:0,y:0,z:0},0).to(this.interactiveMesh.picto.scale,{x:(a=this.interactiveMesh.picto)==null?void 0:a.userData.scale.x,y:(c=this.interactiveMesh.picto)==null?void 0:c.userData.scale.y,z:(d=this.interactiveMesh.picto)==null?void 0:d.userData.scale.z,ease:"power4.out",overwrite:!1,duration:.5},.5)},400)}prepareTexture(t,e=!0){t.colorSpace=rt,e&&(t.generateMipmaps=!1,t.minFilter=ot)}checkIntersection(t,e="click"){var a;if(this.status.reduce&&!this.status.toggle)return;this.raycaster.setFromCamera(this.mouse,this.getActiveCamera());const i=this.raycaster.intersectObject(this.interactiveMesh.click);let n=[];if(this.interactiveMesh.clickButtton&&(n=this.raycaster.intersectObject(this.interactiveMesh.clickButtton)),e==="move"){const c=i.length>0,d=n.length>0;document.body.style.cursor=c||d?"pointer":"default";const x=(a=this.interactiveMesh.article)==null?void 0:a.getObjectByName("article");x&&!this.isDown&&m.to(x.position,{x:c?.1:0,ease:"power3.out",duration:1})}i.length&&e==="click"&&this.goMiniature(),n.length&&e==="click"&&this.goMiniature()}goMiniature(){var n,a;this.orbitControls.enabled=!1,this.status.reduce=!0,this.toggleShowingInside(!1);const t=(n=this.interactiveMesh.article)==null?void 0:n.getObjectByName("article"),e=(a=this.interactiveMesh.clickButtton)==null?void 0:a.getObjectByName("clickButtton");t&&m.to(t.position,{x:0,ease:"power3.out",duration:1}),e&&m.to(e.scale,{x:0,y:0,z:0,ease:"power3.out",duration:.5,onComplete:()=>{var c;(c=e.parent)==null||c.remove(e),this.interactiveMesh.clickButtton=void 0}}),document.body.style.cursor="default";const i=ct(35,this.camera);m.timeline().to(this.getActiveCamera().position,{z:35,x:this.orbitDefaultState.cam.x,y:this.orbitDefaultState.cam.y,ease:"power4.inOut",duration:1.5},0).to(this.orbitControls.target,{z:this.orbitDefaultState.target.z,y:this.orbitDefaultState.target.y,x:this.orbitDefaultState.target.x,ease:"power4.inOut",duration:1.5},0).to(this.container.position,{x:-(i.width/2)+this.container.scale.x*1.8,y:i.height/2-this.container.scale.y*1.8,ease:"power4.inOut",duration:1.5},.25).add(()=>{const{width:c,height:d}=ht(this.container,this.camera);F.emit(U.OBJECT_SHOW_ARTICLE,{width:c,height:d})},1.5),this.interactiveMesh.picto&&this.userInteract()}revertToInteractive(){m.timeline().to(this.getActiveCamera().position,{z:5,ease:"power4.inOut",duration:1.5},.25).to(this.container.position,{x:-this.container.scale.x/2,y:0,ease:"power4.inOut",duration:1.5},0).add(()=>{this.status.reduce=!1,this.toggleShowingInside(!0),this.orbitControls.enabled=!0},1.3)}userInteract(){g.hasInteract.vinyl||(g.toggleInteraction(!0,"vinyl"),this.interactiveMesh.picto&&m.timeline({onComplete:()=>{this.container.remove(this.interactiveMesh.picto),this.interactiveMesh.picto=void 0}}).to(this.interactiveMesh.picto.scale,{x:0,y:0,z:0,ease:"power4.out",duration:.5},0))}}export{xt as VinylScene};
//# sourceMappingURL=VinylScene-BZ0JqxPD.js.map

var q=Object.defineProperty;var J=(p,u,t)=>u in p?q(p,u,{enumerable:!0,configurable:!0,writable:!0,value:t}):p[u]=t;var a=(p,u,t)=>J(p,typeof u!="symbol"?u+"":u,t);import{W as K,d as g}from"./easing-0f4db1c0.esm-BEMtKdpm.js";import{bX as Z,cE as Q,bT as V,cF as $,cC as tt,an as et,ao as it,ab as st,cG as w,ac as at,aa as nt,bU as y,cD as X,bS as x,bV as ot,cH as rt,cI as ct,av as ht,au as lt,q as M}from"./vendor-Dk7UPmZi.js";import{w as h,h as b,e as H,E as U,r as dt,K as mt}from"./app-8gBICEsG.js";import{O as ut,R as gt}from"./RoomEnvironment-Cuz8oAXf.js";import"./@debug-lodash-BIjirobg.js";const pt=350;class xt extends K{constructor(t){super(t);a(this,"handlers");a(this,"mouse",new Z);a(this,"moveArticle",!1);a(this,"raycaster");a(this,"clickTimers",{start:0,end:0});a(this,"isDown",!1);a(this,"container");a(this,"interactiveMesh",{});a(this,"lights",{});a(this,"status",{toggle:!1,reduce:!1});a(this,"orbitControls");a(this,"orbitDefaultState",{});a(this,"pmremGenerator");return h.toneMapping=Q,this.handlers={clickDown:this.onClickDown.bind(this),click:this.onClick.bind(this),move:this.onMouseMove.bind(this)},this.container=new V,this.container.position.x=-this.container.scale.x/2,this.container.visible=!1,this.orbitControls=new ut(this.getActiveCamera(),h.domElement),this.orbitControls.enableDamping=!0,this.orbitControls.dampingFactor=.1,this.orbitControls.enablePan=!1,this.orbitControls.enableZoom=!1,this.pmremGenerator=new $(h),this.pmremGenerator.compileEquirectangularShader(),this.scene.environment=this.pmremGenerator.fromScene(new gt).texture,this.scene.environmentIntensity=.25,this.raycaster=new tt,this}async build(){var f,k,C,S,D,E,T,O,_,A,B,I,L,z,F,G,R,j,P,N,W;this.scene.add(this.container);const t=b.getModel("cd").clone();t.name="cd",t.rotation.y=-Math.PI/2,t.scale.multiplyScalar(.7),this.container.add(t),t.traverse(s=>{const n=s;n.name==="CD_1"&&(this.interactiveMesh.disc=n,this.interactiveMesh.disc.position.set(0,0,0)),n.name==="Case_Front_0"&&(this.interactiveMesh.caseFront=n,this.interactiveMesh.caseFront.rotation.y=0),n.name==="Case_Back_2"&&(this.interactiveMesh.caseBack=n)});const e=new et().setFromObject(this.container).getSize(new it);t.position.y=-e.y/2,t.position.x=e.x/2;const r=await((C=b.getLoader("texture"))==null?void 0:C.loadAsync(((f=this.settings)==null?void 0:f.folder)+((k=this.settings)==null?void 0:k.recto)));if(r){this.prepareTexture(r);const n=((S=this.interactiveMesh.caseFront)==null?void 0:S.getObjectByName("Object_11")).material;n.map=r,n.side=st;const o=(D=this.interactiveMesh.caseFront)==null?void 0:D.getObjectByName("Object_10"),l=o==null?void 0:o.material,d=new w().copy(l);d.opacity=1,d.side=at,d.color.setStyle("#3f3f3f"),o.material=d}const c=await((O=b.getLoader("texture"))==null?void 0:O.loadAsync(((E=this.settings)==null?void 0:E.folder)+((T=this.settings)==null?void 0:T.verso)));if(c){this.prepareTexture(c);const s=new w({color:4144959,roughness:.5,metalness:.5}),n=new w({side:nt,map:c}),o=new y(new X(1,1,.015),[s,s,s,s,s,n]);o.rotation.y=Math.PI/2,o.position.x=-.02,o.position.z=-.1,o.scale.multiplyScalar(1.97),(_=this.interactiveMesh.caseBack)==null||_.add(o);const l=(A=this.interactiveMesh.caseBack)==null?void 0:A.getObjectByName("Object_5");l&&(l.material.opacity=.05)}if((B=this.settings)!=null&&B.article){const s=new V;this.container.add(s),this.interactiveMesh.article=s;const n=typeof((I=this.settings)==null?void 0:I.article)!="string",o=((L=this.settings)==null?void 0:L.folder)+(n?(z=this.settings)==null?void 0:z.article[0]:(F=this.settings)==null?void 0:F.article),l=await((G=b.getLoader("texture"))==null?void 0:G.loadAsync(o));if(l){this.prepareTexture(l,!1);const d=new x({color:16777215}),v=new y(new X(1,1,0),[d,d,d,d,new x({map:l}),d]),Y=l.image.width/l.image.height;v.name="article",v.scale.set((R=this.settings)==null?void 0:R.article_scale,((j=this.settings)==null?void 0:j.article_scale)/Y,(P=this.settings)==null?void 0:P.article_scale).multiplyScalar(.5),s.position.z=-.04,s.position.x=.2,s.add(v),(N=this.settings)!=null&&N.article_offset&&(s.position.x+=(W=this.settings)==null?void 0:W.article_offset);const m=new y(new ot(1,1),new x({transparent:!0,opacity:0}));m.name="click",m.userData.x=m.position.x,m.scale.set(.5,v.scale.y,1),m.userData.endX=m.position.x+(v.scale.x/2-m.scale.x/2),this.interactiveMesh.click=m,s.add(m)}}this.lights={ambient:new rt(16777215,3),directional:new ct(16777215,1)},this.container.add(this.lights.ambient),this.lights.directional.position.set(-3,2,7.5),this.container.add(this.lights.directional),H.emit(U.OBJECT_DETAIL_READY),this.orbitDefaultState.target=this.orbitControls.target.clone(),this.orbitDefaultState.cam=this.getActiveCamera().position.clone(),this.addEvents()}addEvents(){var t,i,e;(t=h)==null||t.domElement.addEventListener("pointerdown",this.handlers.clickDown),(i=h)==null||i.domElement.addEventListener("pointerup",this.handlers.click),(e=h)==null||e.domElement.addEventListener("mousemove",this.handlers.move)}removeEvents(){var t,i,e;(t=h)==null||t.domElement.removeEventListener("pointerdown",this.handlers.clickDown),(i=h)==null||i.domElement.removeEventListener("pointerup",this.handlers.click),(e=h)==null||e.domElement.removeEventListener("mousemove",this.handlers.move)}resize(){super.resize()}render(t){var i,e;this.scene.children.length?(super.render(t),this.interactiveMesh.disc&&(g(this.container.rotation,"y",this.status.toggle?-Math.PI/32:0,.2,t.delta),g(this.interactiveMesh.caseFront.rotation,"y",this.status.toggle?-Math.PI/8:0,.2,t.delta),this.moveArticle&&(this.interactiveMesh.article&&(g(this.interactiveMesh.article.position,"z",this.status.toggle?.06:-.08,.25,t.delta),g(this.interactiveMesh.article.position,"x",this.status.toggle?(((i=this.settings)==null?void 0:i.article_offset)??0)+.8:(((e=this.settings)==null?void 0:e.article_offset)??0)+.2,.25,t.delta),g(this.interactiveMesh.click.position,"x",this.status.toggle?this.interactiveMesh.click.userData.endX:this.interactiveMesh.click.userData.x,.25,t.delta)),g(this.interactiveMesh.disc.position,"z",this.status.toggle?-1:0,.25,t.delta),g(this.interactiveMesh.disc.position,"x",this.status.toggle?.1:0,.25,t.delta)))):(super.render(t),this.build()),this.raycaster.setFromCamera(this.mouse,this.getActiveCamera()),this.orbitControls.update()}dispose(){this.disposeGeometries(this.container),this.interactiveMesh={},super.dispose(),this.removeEvents(),document.body.style.cursor="default"}onClickDown(){this.clickTimers.start=Date.now(),this.clickTimers.end=0,this.isDown=!0}onClick(t){var e;this.clickTimers.end=Date.now(),this.isDown=!1,this.clickTimers.end-this.clickTimers.start<=pt&&(e=this.settings)!=null&&e.article&&this.interactiveMesh.article&&this.checkIntersection(t,"click")}onMouseMove(t){var i;this.getMousePosition(t),(i=this.settings)!=null&&i.article&&this.interactiveMesh.article&&this.checkIntersection(t,"move")}getMousePosition(t){const e=t.currentTarget.getBoundingClientRect();let r=0,c=0;r=t.clientX-(e==null?void 0:e.left),c=t.clientY-(e==null?void 0:e.top),this.mouse.x=r/h.domElement.offsetWidth*2-1,this.mouse.y=-(c/h.domElement.offsetHeight)*2+1}show(){this.container.visible=!0}toggleShowingInside(t){this.status.toggle=t,setTimeout(()=>{this.moveArticle=t},400)}prepareTexture(t,i=!0){t.colorSpace=ht,i&&(t.generateMipmaps=!1,t.minFilter=lt)}checkIntersection(t,i="click"){var r;if(this.status.reduce&&!this.status.toggle)return;const e=this.raycaster.intersectObject(this.interactiveMesh.click);if(i==="move"){const c=e.length>0;document.body.style.cursor=c?"pointer":"default";const f=(r=this.interactiveMesh.article)==null?void 0:r.getObjectByName("article");f&&!this.isDown&&M.to(f.position,{x:c?.1:0,ease:"power3.out",duration:1})}e.length&&i==="click"&&this.goMiniature()}goMiniature(){var e;this.orbitControls.enabled=!1,this.status.reduce=!0,this.toggleShowingInside(!1);const t=(e=this.interactiveMesh.article)==null?void 0:e.getObjectByName("article");t&&M.to(t.position,{x:0,ease:"power3.out",duration:1}),document.body.style.cursor="default";const i=dt(20,this.camera);M.timeline().to(this.getActiveCamera().position,{z:20,x:this.orbitDefaultState.cam.x,y:this.orbitDefaultState.cam.y,ease:"power4.inOut",duration:1.5},0).to(this.orbitControls.target,{z:this.orbitDefaultState.target.z,y:this.orbitDefaultState.target.y,x:this.orbitDefaultState.target.x,ease:"power4.inOut",duration:1.5},0).to(this.container.position,{x:-(i.width/2)+this.container.scale.x*.75,y:i.height/2-this.container.scale.y*1,ease:"power4.inOut",duration:1.5},.25).add(()=>{const{width:r,height:c}=mt(this.container,this.camera);H.emit(U.OBJECT_SHOW_ARTICLE,{width:r,height:c})},1.5)}revertToInteractive(){M.timeline().to(this.getActiveCamera().position,{z:5,ease:"power4.inOut",duration:1.5},.25).to(this.container.position,{x:-this.container.scale.x/2,y:0,ease:"power4.inOut",duration:1.5},0).add(()=>{this.status.reduce=!1,this.toggleShowingInside(!0),this.orbitControls.enabled=!0},1.3)}}export{xt as CDScene};
//# sourceMappingURL=CDScene-C4xy4NPw.js.map

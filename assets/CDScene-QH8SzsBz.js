var K=Object.defineProperty;var Z=(b,f,t)=>f in b?K(b,f,{enumerable:!0,configurable:!0,writable:!0,value:t}):b[f]=t;var l=(b,f,t)=>Z(b,typeof f!="symbol"?f+"":f,t);import{W as $,d as w}from"./easing-0f4db1c0.esm-CUoNLiYe.js";import{b_ as Q,cF as tt,bW as H,cD as et,an as it,ao as st,ab as at,cH as B,ac as nt,aa as ot,bX as D,cE as J,bV as C,bY as S,cI as rt,cJ as ct,q as v,av as ht,au as lt}from"./vendor-D1O0VZ-0.js";import{y as p,h as y,a as x,e as U,E as q,x as ut,O as dt}from"./app-BHllM0oC.js";import{O as pt}from"./OrbitControls-C-ReMBYG.js";import"./@debug-lodash-BIjirobg.js";const mt=350;class bt extends ${constructor(t){super(t);l(this,"handlers");l(this,"mouse",new Q);l(this,"moveArticle",!1);l(this,"raycaster");l(this,"clickTimers",{start:0,end:0});l(this,"isDown",!1);l(this,"container");l(this,"interactiveMesh",{});l(this,"lights",{});l(this,"status",{toggle:!1,reduce:!1});l(this,"orbitControls");l(this,"orbitDefaultState",{});return this.camera.position.z=3.5,p.toneMapping=tt,this.handlers={clickDown:this.onClickDown.bind(this),click:this.onClick.bind(this),move:this.onMouseMove.bind(this)},this.container=new H,this.container.position.x=-this.container.scale.x/2,this.container.visible=!1,this.orbitControls=new pt(this.getActiveCamera(),p.domElement),this.orbitControls.enableDamping=!0,this.orbitControls.dampingFactor=.1,this.orbitControls.enablePan=!1,this.orbitControls.enableZoom=!1,this.raycaster=new et,this}async build(){var h,m,k,E,T,z,I,O,_,A,L,F,j,P,N,R,G,W,V,X,Y;this.scene.add(this.container);const t=y.getModel("cd").clone();t.name="cd",t.rotation.y=-Math.PI/2,t.scale.multiplyScalar(.7),this.container.add(t),t.traverse(s=>{const c=s;c.name==="CD_1"&&(this.interactiveMesh.disc=c,this.interactiveMesh.disc.position.set(0,0,0)),c.name==="Case_Front_0"&&(this.interactiveMesh.caseFront=c,this.interactiveMesh.caseFront.rotation.y=0),c.name==="Case_Back_2"&&(this.interactiveMesh.caseBack=c)});const e=new it().setFromObject(this.container).getSize(new st);t.position.y=-e.y/2,t.position.x=e.x/2;const n=await((k=y.getLoader("texture"))==null?void 0:k.loadAsync(((h=this.settings)==null?void 0:h.folder)+((m=this.settings)==null?void 0:m.recto)));if(n){this.prepareTexture(n);const c=((E=this.interactiveMesh.caseFront)==null?void 0:E.getObjectByName("Object_11")).material;c.map=n,c.side=at;const a=(T=this.interactiveMesh.caseFront)==null?void 0:T.getObjectByName("Object_10"),d=a==null?void 0:a.material,o=new B().copy(d);o.opacity=1,o.side=nt,o.color.setStyle("#3f3f3f"),a.material=o}const r=await((O=y.getLoader("texture"))==null?void 0:O.loadAsync(((z=this.settings)==null?void 0:z.folder)+((I=this.settings)==null?void 0:I.verso)));if(r){this.prepareTexture(r);const s=new B({color:4144959,roughness:.5,metalness:.5}),c=new B({side:ot,map:r}),a=new D(new J(1,1,.015),[s,s,s,s,s,c]);a.rotation.y=Math.PI/2,a.position.x=-.02,a.position.z=-.1,a.scale.multiplyScalar(1.97),(_=this.interactiveMesh.caseBack)==null||_.add(a);const d=(A=this.interactiveMesh.caseBack)==null?void 0:A.getObjectByName("Object_5");d&&(d.material.opacity=.05)}if((L=this.settings)!=null&&L.article){const s=new H;this.container.add(s),this.interactiveMesh.article=s;const c=typeof((F=this.settings)==null?void 0:F.article)!="string",a=((j=this.settings)==null?void 0:j.folder)+(c?(P=this.settings)==null?void 0:P.article[0]:(N=this.settings)==null?void 0:N.article),d=await((R=y.getLoader("texture"))==null?void 0:R.loadAsync(a));if(d){this.prepareTexture(d,!1);const o=new C({color:16777215}),M=new D(new J(1,1,0),[o,o,o,o,new C({map:d}),o]),u=d.image.width/d.image.height;M.name="article",M.scale.set((G=this.settings)==null?void 0:G.article_scale,((W=this.settings)==null?void 0:W.article_scale)/u,(V=this.settings)==null?void 0:V.article_scale).multiplyScalar(.5),s.position.z=-.04,s.position.x=.2,s.add(M),(X=this.settings)!=null&&X.article_offset&&(s.position.x+=(Y=this.settings)==null?void 0:Y.article_offset);const g=new D(new S(1,1),new C({transparent:!0,color:"#FF0000",opacity:0}));g.name="click",g.userData.x=g.position.x,g.scale.set(.5,M.scale.y,1),g.userData.endX=g.position.x+(M.scale.x/2-g.scale.x/2),this.interactiveMesh.click=g,s.add(g)}if(!x.state.supports.install&&!x.hasInteract.disc){const o=y.getTexture("sprite-object");if(o){this.prepareTexture(o,!1);const M=o.image.width/o.image.height,u=new D(new S(1,1),new C({map:o,transparent:!0}));u.name="clickButtton",u.scale.set(1,1/M,1).multiplyScalar(.5),u.position.x=t.scale.x/2+s.scale.x-.05,u.position.z=.07,u.userData.scale=u.scale.clone().multiplyScalar(.5),u.scale.set(0,0,0),this.interactiveMesh.clickButtton=u,this.container.add(u)}}}if(x.state.supports.install&&!x.hasInteract.disc){const s=y.getTexture("touch-object");if(s){this.prepareTexture(s,!1);const c=s.image.width/s.image.height,a=new D(new S(1,1),new C({map:s,transparent:!0}));a.name="picto",a.scale.set(1,1/c,1).multiplyScalar(.5),a.position.x=t.scale.x/2+this.interactiveMesh.disc.scale.x+.3,a.position.z=.03,a.userData.scale=a.scale.clone().multiplyScalar(.5),a.scale.set(0,0,0),this.interactiveMesh.picto=a,this.container.add(a)}}this.lights={ambient:new rt(16777215,3),directional:new ct(16777215,1)},this.container.add(this.lights.ambient),this.lights.directional.position.set(-3,2,7.5),this.container.add(this.lights.directional),U.emit(q.OBJECT_DETAIL_READY),this.orbitDefaultState.target=this.orbitControls.target.clone(),this.orbitDefaultState.cam=this.getActiveCamera().position.clone(),v.timeline().from(this.container.rotation,{z:Math.PI/4,x:-Math.PI/2,ease:"power4.inOut",duration:2}),this.addEvents()}addEvents(){var t,i,e;(t=p)==null||t.domElement.addEventListener("pointerdown",this.handlers.clickDown),(i=p)==null||i.domElement.addEventListener("pointerup",this.handlers.click),(e=p)==null||e.domElement.addEventListener("pointermove",this.handlers.move)}removeEvents(){var t,i,e;(t=p)==null||t.domElement.removeEventListener("pointerdown",this.handlers.clickDown),(i=p)==null||i.domElement.removeEventListener("pointerup",this.handlers.click),(e=p)==null||e.domElement.removeEventListener("pointermove",this.handlers.move)}resize(){super.resize()}render(t){var i,e;this.scene.children.length?(super.render(t),this.interactiveMesh.disc&&(w(this.container.rotation,"y",this.status.toggle?-Math.PI/32:0,.2,t.delta),w(this.interactiveMesh.caseFront.rotation,"y",this.status.toggle?-Math.PI/8:0,.2,t.delta),this.moveArticle&&(this.interactiveMesh.article&&(w(this.interactiveMesh.article.position,"z",this.status.toggle?.06:-.08,.25,t.delta),w(this.interactiveMesh.article.position,"x",this.status.toggle?(((i=this.settings)==null?void 0:i.article_offset)??0)+.8:(((e=this.settings)==null?void 0:e.article_offset)??0)+.2,.25,t.delta),w(this.interactiveMesh.click.position,"x",this.status.toggle?this.interactiveMesh.click.userData.endX:this.interactiveMesh.click.userData.x,.25,t.delta)),w(this.interactiveMesh.disc.position,"z",this.status.toggle?-1:0,.25,t.delta),w(this.interactiveMesh.disc.position,"x",this.status.toggle?.1:0,.25,t.delta)))):(super.render(t),this.build()),this.orbitControls.update()}dispose(){this.disposeGeometries(this.container),this.interactiveMesh={},super.dispose(),this.removeEvents(),document.body.style.cursor="default"}onClickDown(){this.clickTimers.start=Date.now(),this.clickTimers.end=0,this.isDown=!0}onClick(t){var e;this.clickTimers.end=Date.now(),this.isDown=!1,this.clickTimers.end-this.clickTimers.start<=mt&&(e=this.settings)!=null&&e.article&&this.interactiveMesh.article&&(this.getMousePosition(t),this.checkIntersection(t,"click"))}onMouseMove(t){var i;if(x.state.supports.install){this.userInteract();return}this.getMousePosition(t),(i=this.settings)!=null&&i.article&&this.interactiveMesh.article&&this.checkIntersection(t,"move")}getMousePosition(t){const e=t.currentTarget.getBoundingClientRect();let n=0,r=0;n=t.clientX-(e==null?void 0:e.left),r=t.clientY-(e==null?void 0:e.top),this.mouse.x=n/p.domElement.offsetWidth*2-1,this.mouse.y=-(r/p.domElement.offsetHeight)*2+1}show(){this.container.visible=!0}toggleShowingInside(t){this.status.toggle=t,setTimeout(()=>{var i,e,n,r,h,m;this.moveArticle=t,this.status.toggle&&this.interactiveMesh.clickButtton&&(this.interactiveMesh.clickButtton.parent||this.container.add(this.interactiveMesh.clickButtton),v.timeline().set(this.interactiveMesh.clickButtton.scale,{x:0,y:0,z:0},0).to(this.interactiveMesh.clickButtton.scale,{x:(i=this.interactiveMesh.clickButtton)==null?void 0:i.userData.scale.x,y:(e=this.interactiveMesh.clickButtton)==null?void 0:e.userData.scale.y,z:(n=this.interactiveMesh.clickButtton)==null?void 0:n.userData.scale.z,ease:"power4.out",overwrite:!1,duration:.5},.5)),this.interactiveMesh.picto&&v.timeline().set(this.interactiveMesh.picto.scale,{x:0,y:0,z:0},0).to(this.interactiveMesh.picto.scale,{x:(r=this.interactiveMesh.picto)==null?void 0:r.userData.scale.x,y:(h=this.interactiveMesh.picto)==null?void 0:h.userData.scale.y,z:(m=this.interactiveMesh.picto)==null?void 0:m.userData.scale.z,ease:"power4.out",overwrite:!1,duration:.5},.5)},400)}prepareTexture(t,i=!0){t.colorSpace=ht,i&&(t.generateMipmaps=!1,t.minFilter=lt)}checkIntersection(t,i="click"){var r;if(this.status.reduce&&!this.status.toggle)return;this.raycaster.setFromCamera(this.mouse,this.getActiveCamera());const e=this.raycaster.intersectObject(this.interactiveMesh.click);let n=[];if(this.interactiveMesh.clickButtton&&(n=this.raycaster.intersectObject(this.interactiveMesh.clickButtton)),i==="move"){const h=e.length>0,m=n.length>0;document.body.style.cursor=h||m?"pointer":"default";const k=(r=this.interactiveMesh.article)==null?void 0:r.getObjectByName("article");k&&!this.isDown&&v.to(k.position,{x:h?.1:0,ease:"power3.out",duration:1})}e.length&&i==="click"&&this.goMiniature(),n.length&&i==="click"&&this.goMiniature()}goMiniature(){var n,r;this.orbitControls.enabled=!1,this.status.reduce=!0,this.toggleShowingInside(!1);const t=(n=this.interactiveMesh.article)==null?void 0:n.getObjectByName("article"),i=(r=this.interactiveMesh.clickButtton)==null?void 0:r.getObjectByName("clickButtton");t&&v.to(t.position,{x:0,ease:"power3.out",duration:1}),i&&v.to(i.scale,{x:0,y:0,z:0,ease:"power3.out",duration:.5,onComplete:()=>{var h;(h=i.parent)==null||h.remove(i),this.interactiveMesh.clickButtton=void 0}}),document.body.style.cursor="default";const e=ut(20,this.camera);v.timeline().to(this.getActiveCamera().position,{z:20,x:this.orbitDefaultState.cam.x,y:this.orbitDefaultState.cam.y,ease:"power4.inOut",duration:1.5},0).to(this.orbitControls.target,{z:this.orbitDefaultState.target.z,y:this.orbitDefaultState.target.y,x:this.orbitDefaultState.target.x,ease:"power4.inOut",duration:1.5},0).to(this.container.position,{x:-(e.width/2)+this.container.scale.x*.75,y:e.height/2-this.container.scale.y*1,ease:"power4.inOut",duration:1.5},.25).add(()=>{const{width:h,height:m}=dt(this.container,this.camera);U.emit(q.OBJECT_SHOW_ARTICLE,{width:h,height:m})},1.5),this.interactiveMesh.picto&&this.userInteract()}revertToInteractive(){v.timeline().to(this.getActiveCamera().position,{z:3.5,ease:"power4.inOut",duration:1.5},.25).to(this.container.position,{x:-this.container.scale.x/2,y:0,ease:"power4.inOut",duration:1.5},0).add(()=>{this.status.reduce=!1,this.toggleShowingInside(!0),this.orbitControls.enabled=!0},1.3)}userInteract(){x.hasInteract.disc||(x.toggleInteraction(!0,"disc"),this.interactiveMesh.picto&&v.timeline({onComplete:()=>{this.container.remove(this.interactiveMesh.picto),this.interactiveMesh.picto=void 0}}).to(this.interactiveMesh.picto.scale,{x:0,y:0,z:0,ease:"power4.out",duration:.5},0))}}export{bt as CDScene};
//# sourceMappingURL=CDScene-QH8SzsBz.js.map

var J=Object.defineProperty;var K=(l,h,t)=>h in l?J(l,h,{enumerable:!0,configurable:!0,writable:!0,value:t}):l[h]=t;var s=(l,h,t)=>K(l,typeof h!="symbol"?h+"":h,t);import{W as Z,d}from"./easing-0f4db1c0.esm-DWmpH-gU.js";import{cD as Q,bV as Y,bX as $,cE as tt,bT as b,cF as et,cC as it,bS as y,ac as x,bU as C,cG as D,cH as st,cI as nt,av as at,au as rt,q as v}from"./vendor-Dk7UPmZi.js";import{w as r,h as f,e as H,E as U,r as ot,K as ct}from"./app-i-894-h8.js";import{O as ht,R as lt}from"./RoomEnvironment-Cuz8oAXf.js";import"./@debug-lodash-BIjirobg.js";const M=new Q(1,1,1),w=new Y(1,1),dt=350;class Mt extends Z{constructor(t){super(t);s(this,"handlers");s(this,"mouse",new $);s(this,"moveArticle",!1);s(this,"raycaster");s(this,"clickTimers",{start:0,end:0});s(this,"isDown",!1);s(this,"container");s(this,"interactiveMesh",{});s(this,"lights",{});s(this,"status",{toggle:!1,reduce:!1});s(this,"orbitControls");s(this,"orbitDefaultState",{});s(this,"pmremGenerator");return r.toneMapping=tt,this.handlers={clickDown:this.onClickDown.bind(this),click:this.onClick.bind(this),move:this.onMouseMove.bind(this)},this.container=new b,this.container.position.x=-this.container.scale.x/2,this.container.visible=!1,this.orbitControls=new ht(this.getActiveCamera(),r.domElement),this.orbitControls.enableDamping=!0,this.orbitControls.enablePan=!1,this.orbitControls.dampingFactor=.1,this.orbitControls.enableZoom=!1,this.pmremGenerator=new et(r),this.pmremGenerator.compileEquirectangularShader(),this.scene.environment=this.pmremGenerator.fromScene(new lt).texture,this.scene.environmentIntensity=.25,this.raycaster=new it,this}async build(){var E,k,S,T,I,A,L,O,z,_,G,R,B,P,W,N,V,X,j;this.scene.add(this.container);const t=f.getModel("vinyl").clone();t.name="vinyl",t.scale.multiplyScalar(.09),this.container.add(t),t.traverse(o=>{const p=o;p.name==="Disc"&&(this.interactiveMesh.disc=p,this.interactiveMesh.disc.position.x=0)}),this.interactiveMesh.cover=new b,this.container.add(this.interactiveMesh.cover);const e=await((S=f.getLoader("texture"))==null?void 0:S.loadAsync(((E=this.settings)==null?void 0:E.folder)+((k=this.settings)==null?void 0:k.recto)));e&&this.prepareTexture(e);const i=await((A=f.getLoader("texture"))==null?void 0:A.loadAsync(((T=this.settings)==null?void 0:T.folder)+((I=this.settings)==null?void 0:I.verso)));i&&this.prepareTexture(i),this.interactiveMesh.trancheInsideMaterial=new y({color:(L=this.settings)==null?void 0:L.tranche,transparent:!0,opacity:1});const n=new y({color:(O=this.settings)==null?void 0:O.tranche,side:x}),a=new C(M,[this.interactiveMesh.trancheInsideMaterial,n,n,n,new D({map:e,side:x,roughness:.5,metalness:.5}),new D({map:i,side:x})]),g=(e==null?void 0:e.image.width)/(e==null?void 0:e.image.height);if(a.name="cover",a.scale.set(2.5,2.5/g,.05),this.interactiveMesh.cover.add(a),(z=this.settings)!=null&&z.article){const o=new b;this.container.add(o),this.interactiveMesh.article=o;const p=typeof((_=this.settings)==null?void 0:_.article)!="string",q=((G=this.settings)==null?void 0:G.folder)+(p?(R=this.settings)==null?void 0:R.article[0]:(B=this.settings)==null?void 0:B.article),m=await((P=f.getLoader("texture"))==null?void 0:P.loadAsync(q));if(m){this.prepareTexture(m);const u=new C(w,new D({map:m,roughness:.5,metalness:.5})),F=m.image.width/m.image.height;u.name="article",u.scale.set((W=this.settings)==null?void 0:W.article_scale,((N=this.settings)==null?void 0:N.article_scale)/F,(V=this.settings)==null?void 0:V.article_scale),o.position.z=.01,o.position.y=.2,o.add(u),(X=this.settings)!=null&&X.article_offset&&(o.position.x+=(j=this.settings)==null?void 0:j.article_offset);const c=new C(new Y(1,1),new y({transparent:!0,opacity:0}));c.name="click",c.scale.set(1,u.scale.y,1),c.userData.x=c.position.x,c.userData.endX=c.userData.x+(u.scale.x/2-c.scale.x/2),this.interactiveMesh.click=c,o.add(c)}}this.lights={ambient:new st(16777215,3),directional:new nt(16777215,1)},this.container.add(this.lights.ambient),this.lights.directional.position.set(-3,2,7.5),this.container.add(this.lights.directional),H.emit(U.OBJECT_DETAIL_READY),this.orbitDefaultState.target=this.orbitControls.target.clone(),this.orbitDefaultState.cam=this.getActiveCamera().position.clone(),this.addEvents()}addEvents(){var t,e,i;(t=r)==null||t.domElement.addEventListener("pointerdown",this.handlers.clickDown),(e=r)==null||e.domElement.addEventListener("pointerup",this.handlers.click),(i=r)==null||i.domElement.addEventListener("mousemove",this.handlers.move)}removeEvents(){var t,e,i;(t=r)==null||t.domElement.removeEventListener("pointerdown",this.handlers.clickDown),(e=r)==null||e.domElement.removeEventListener("pointerup",this.handlers.click),(i=r)==null||i.domElement.removeEventListener("mousemove",this.handlers.move)}resize(){super.resize()}render(t){var e,i;this.scene.children.length?(super.render(t),this.interactiveMesh.disc&&this.interactiveMesh.cover&&(d(this.interactiveMesh.disc.position,"x",this.status.toggle?this.interactiveMesh.disc.scale.x*15:0,.2,t.delta),d(this.interactiveMesh.disc.rotation,"z",this.status.toggle?Math.PI/2:0,.2,t.delta),this.interactiveMesh.trancheInsideMaterial&&d(this.interactiveMesh.trancheInsideMaterial,"opacity",this.status.toggle?0:1,.2,t.delta),this.interactiveMesh.article&&this.moveArticle&&(d(this.interactiveMesh.article.position,"x",this.status.toggle?(((e=this.settings)==null?void 0:e.article_offset)??0)+.65:((i=this.settings)==null?void 0:i.article_offset)??0,.25,t.delta),d(this.interactiveMesh.article.rotation,"z",this.status.toggle?-Math.PI/8:0,.25,t.delta),d(this.interactiveMesh.click.position,"x",this.status.toggle?this.interactiveMesh.click.userData.endX:this.interactiveMesh.click.userData.x,.25,t.delta)))):(super.render(t),this.build()),this.raycaster.setFromCamera(this.mouse,this.getActiveCamera()),this.orbitControls.update()}dispose(){var t;w==null||w.dispose(),M==null||M.dispose(),(t=this.interactiveMesh.trancheInsideMaterial)==null||t.dispose(),this.disposeGeometries(this.container),this.interactiveMesh={},super.dispose(),this.removeEvents(),document.body.style.cursor="default"}onClickDown(){this.clickTimers.start=Date.now(),this.clickTimers.end=0,this.isDown=!0}onClick(t){var i;this.clickTimers.end=Date.now(),this.isDown=!1,this.clickTimers.end-this.clickTimers.start<=dt&&(i=this.settings)!=null&&i.article&&this.interactiveMesh.article&&this.checkIntersection(t,"click")}onMouseMove(t){var e;this.getMousePosition(t),(e=this.settings)!=null&&e.article&&this.interactiveMesh.article&&this.checkIntersection(t,"move")}getMousePosition(t){const i=t.currentTarget.getBoundingClientRect();let n=0,a=0;n=t.clientX-(i==null?void 0:i.left),a=t.clientY-(i==null?void 0:i.top),this.mouse.x=n/r.domElement.offsetWidth*2-1,this.mouse.y=-(a/r.domElement.offsetHeight)*2+1}show(){this.container.visible=!0}toggleShowingInside(t){this.status.toggle=t,setTimeout(()=>{this.moveArticle=t},400)}prepareTexture(t){t.colorSpace=at,t.generateMipmaps=!1,t.minFilter=rt}checkIntersection(t,e="click"){var n;if(this.status.reduce&&!this.status.toggle)return;const i=this.raycaster.intersectObject(this.interactiveMesh.click);if(e==="move"){const a=i.length>0;document.body.style.cursor=a?"pointer":"default";const g=(n=this.interactiveMesh.article)==null?void 0:n.getObjectByName("article");g&&!this.isDown&&v.to(g.position,{x:a?.1:0,ease:"power3.out",duration:1})}i.length&&e==="click"&&this.goMiniature()}goMiniature(){var i;this.orbitControls.enabled=!1,this.status.reduce=!0,this.toggleShowingInside(!1);const t=(i=this.interactiveMesh.article)==null?void 0:i.getObjectByName("article");t&&v.to(t.position,{x:0,ease:"power3.out",duration:1}),document.body.style.cursor="default";const e=ot(35,this.camera);v.timeline().to(this.getActiveCamera().position,{z:35,x:this.orbitDefaultState.cam.x,y:this.orbitDefaultState.cam.y,ease:"power4.inOut",duration:1.5},0).to(this.orbitControls.target,{z:this.orbitDefaultState.target.z,y:this.orbitDefaultState.target.y,x:this.orbitDefaultState.target.x,ease:"power4.inOut",duration:1.5},0).to(this.container.position,{x:-(e.width/2)+this.container.scale.x*1.8,y:e.height/2-this.container.scale.y*1.8,ease:"power4.inOut",duration:1.5},.25).add(()=>{const{width:n,height:a}=ct(this.container,this.camera);H.emit(U.OBJECT_SHOW_ARTICLE,{width:n,height:a})},1.5)}revertToInteractive(){v.timeline().to(this.getActiveCamera().position,{z:5,ease:"power4.inOut",duration:1.5},.25).to(this.container.position,{x:-this.container.scale.x/2,y:0,ease:"power4.inOut",duration:1.5},0).add(()=>{this.status.reduce=!1,this.toggleShowingInside(!0),this.orbitControls.enabled=!0},1.3)}}export{Mt as VinylScene};
//# sourceMappingURL=VinylScene-DmKRjfdi.js.map
